<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Svemirska Postaja</title>
    <style>
        body {
            font-family: "Comic Sans MS", "Comic Sans", "Chalkboard SE", cursive;
            background: radial-gradient(circle at center, #0a1128 0%, #05070a 100%);
            color: #00ffcc;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: auto;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .header {
            text-align: center;
            padding: 10px;
            background: rgba(0, 255, 204, 0.1);
            width: 100%;
            border-bottom: 3px solid #00ffcc;
            margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: clamp(1.8rem, 4vh, 2.8rem);
            color: #00ffcc;
            text-shadow: 2px 2px 0px #004422, 0 0 10px #00ffcc;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .header p {
            margin: 5px 0 0 0;
            font-size: clamp(1rem, 2vh, 1.3rem);
            color: #ffffff;
            font-weight: bold;
        }

        /* Glavni HUB postaje */
        #station-core {
            width: 95%;
            max-width: 600px;
            flex: 1.5;
            border: 5px solid #00ffcc;
            border-radius: 35px;
            margin: 10px auto;
            background: #111;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.4s;
            padding: 15px;
            box-shadow: inset 0 0 40px rgba(0, 255, 204, 0.15), 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #energy-display {
            font-size: clamp(3rem, 10vh, 5rem);
            font-weight: bold;
            color: #ff4444;
            margin: 5px 0;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        /* Zona za prikljuƒçivanje */
        #docking-zone {
            width: 90%;
            min-height: 100px;
            border: 3px dashed rgba(0, 255, 204, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            flex-wrap: wrap;
            border-radius: 20px;
        }

        /* Skladi≈°te modula (Donji dio) */
        #modules-storage {
            width: 95%;
            max-width: 850px;
            flex: 1;
            border: 3px solid #333;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            flex-shrink: 0;
        }

        /* Izgled modula */
        .module {
            width: 80px;
            height: 110px;
            background: #2c3e50;
            border: 3px solid #00ffcc;
            border-radius: 15px;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            flex-shrink: 0;
            transition: 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        .module:hover {
            transform: scale(1.1) rotate(3deg);
            background: #34495e;
            box-shadow: 0 0 20px #00ffcc;
            border-color: #fff;
        }

        .panels-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }

        .panel {
            width: 14px;
            height: 14px;
            background: #00d2ff;
            border: 1px solid white;
            box-shadow: 0 0 8px rgba(0, 210, 255, 0.5);
        }

        .module-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            pointer-events: none;
            font-weight: bold;
            color: #fff;
            letter-spacing: 0.5px;
        }

        /* Stanja sustava */
        .powered-up {
            background: #004422 !important;
            border-color: #00ff00 !important;
            box-shadow: 0 0 50px #00ff00, inset 0 0 30px #00ff00 !important;
        }

        .powered-up #energy-display {
            color: #00ff00 !important;
            text-shadow: 0 0 25px #00ff00;
        }

        .overload {
            animation: shake 0.2s infinite;
            border-color: #ff4444 !important;
            box-shadow: 0 0 40px #ff4444 !important;
        }

        @keyframes shake {
            0% {
                transform: translate(2px, 2px);
            }

            50% {
                transform: translate(-2px, -2px);
            }

            100% {
                transform: translate(2px, -2px);
            }
        }

        #status-msg {
            height: 40px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.5rem;
            color: #00ffcc;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
            text-align: center;
        }

        /* MODALS (Orbit Style) */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(5px);
        }

        .card {
            background: #002b36;
            /* Blueprint blue */
            border: 2px solid #fff;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 0 10px #002b36, 0 0 0 12px #fff;
            /* Double border effect */
            animation: unfold 0.6s;
            background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        @keyframes unfold {
            0% {
                transform: scaleY(0.1);
            }

            100% {
                transform: scaleY(1);
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .card h2 {
            margin-top: 0;
            font-size: 2.5rem;
            text-transform: uppercase;
        }

        .tutorial-step {
            margin-bottom: 15px;
            font-size: 1.2rem;
            /* Adjusted for solar game content */
            line-height: 1.5;
            color: #fff;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-start {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            font-weight: bold;
            box-shadow: 0 6px 0 #27ae60;
            transition: transform 0.1s;
        }

        .btn-start:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #27ae60;
        }

        /* Legacy Button Support if needed, or replacement */
        .btn-modal {
            /* Kept for compatibility if other modals use it, but re-styled to match btn-start roughly or just unused */
            padding: 12px 30px;
            font-size: 1.2rem;
            border: 2px solid #00ffcc;
            background: none;
            color: #00ffcc;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: 0.3s;
            margin-top: 20px;
        }

        .btn-modal:hover {
            background: #00ffcc;
            color: #000;
        }

        .level-display {
            font-size: 1.2rem;
            color: #00ffcc;
            font-weight: bold;
            margin-top: 5px;
            text-shadow: 0 0 8px rgba(0, 255, 204, 0.3);
        }

        .score-display {
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            margin-top: 5px;
        }

        @media (max-height: 800px) {
            .header {
                padding: 5px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            #station-core {
                margin: 5px auto;
            }

            .module {
                width: 70px;
                height: 95px;
            }

            #status-msg {
                font-size: 1.2rem;
                height: 30px;
            }
        }
    </style>
</head>

<body>
    <!-- Povratak Button -->
    <a href="../planet.html"
        style="position: absolute; top: 15px; left: 15px; text-decoration: none; font-size: 1rem; background: rgba(0, 255, 204, 0.1); padding: 8px 15px; border-radius: 30px; border: 1px solid #00ffcc; color: #00ffcc; transition: 0.2s; box-shadow: 0 0 10px rgba(0, 255, 204, 0.3); z-index: 100; font-weight: bold;"
        onmouseover="this.style.transform='scale(1.05)'; this.style.background='rgba(0, 255, 204, 0.2)'"
        onmouseout="this.style.transform='scale(1)'; this.style.background='rgba(0, 255, 204, 0.1)'">
        ‚¨Ö POVRATAK
    </a>

    <div class="header" style="position: relative;">
        <h1>IN≈ΩENJER SVEMIRSKE POSTAJE</h1>
        <div id="levelText" class="level-display">RAZINA: 1 / 10</div>
        <div id="scoreText" class="score-display">BODOVI: 0</div>
        <p id="targetHint">Prebaci module za napajanje. Cilj: <strong>toƒçno 5 panela</strong>.</p>
        <button onclick="showInstructions()"
            style="position: absolute; right: 10px; top: 10px; background: rgba(0, 255, 204, 0.1); border: 1px solid #00ffcc; color: #00ffcc; padding: 10px 20px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s;"
            onmouseover="this.style.transform='scale(1.05)'; this.style.background='rgba(0, 255, 204, 0.2)'"
            onmouseout="this.style.transform='scale(1)'; this.style.background='rgba(0, 255, 204, 0.1)'">
            ‚ùì UPUTE
        </button>
    </div>

    <!-- Postaja -->
    <div id="station-core">
        <div style="font-size: 1rem; color: #00ffcc; font-weight: bold; margin-bottom: 5px;">STATUS ENERGIJE</div>
        <div id="energy-display">0 / 5</div>
        <div id="docking-zone" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
            <!-- Moduli dolaze ovdje -->
        </div>
    </div>

    <div id="status-msg">Sustav ƒçeka napajanje...</div>

    <!-- Skladi≈°te -->
    <div id="modules-storage" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
        <!-- Generirano via JS -->
    </div>


    <!-- SUCCESS MODAL -->
    <div id="success-overlay" class="overlay">
        <div class="card">
            <h2 style="color: #00ff00;">ENERGIJA STABILNA! ‚ö°</h2>
            <p style="font-size: 1.2rem;">Sektor je uspje≈°no spojen na mre≈æu.</p>
            <button class="btn-start" onclick="nextLevel()">DALJE ‚û°</button>
        </div>
    </div>

    <!-- WIN MODAL -->
    <div id="win-overlay" class="overlay">
        <div class="card" style="border-color: #ffd700;">
            <h2 style="color: #ffd700;">MISIJA ZAVR≈†ENA! üèÜ</h2>
            <p id="finalSummary" style="font-size:1.5rem; font-weight:bold; margin: 20px 0;">Osvojeno: 0 / 100 bodova
            </p>
            <p style="font-size:1.1rem; color:#94a3b8;">Bodovi su dodani u tvoj novƒçanik!</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-start" onclick="location.reload()">PONOVO ‚Ü∫</button>
                <button class="btn-start" style="background: #94a3b8;"
                    onclick="window.location.href='../planet.html'">PLANET üè†</button>
            </div>
        </div>
    </div>

    <div id="tutorial-overlay" class="overlay">
        <div class="card">
            <h2 id="tutorial-title" style="color: #00ffcc;">üéì UPUTE</h2>
            <div id="tutorial-content" style="text-align: left; margin-bottom: 20px;">
                <!-- Content injected by JS -->
            </div>
            <button class="btn-start" id="tutorial-main-btn" onclick="closeInstructions()">RAZUMIJEM! üöÄ</button>
        </div>
    </div>

    <script src="../game_storage.js"></script>
    <script>
        const GAME_ID = 'solar_station';
        const moduleNames = ["Kisik", "Lab", "Radar", "Kuhinja", "Sonda", "Radio", "Grijanje", "Voda", "Motor", "Svjetlo", "Baterija", "Kamera"];
        let currentLevel = 1;
        let totalScore = 0;
        let targetEnergy = 5;
        let isComplete = false;
        let isPaused = true;

        // --- Tutorial/Start Logic ---
        function showInstructions() {
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tutorial-title');
            const content = document.getElementById('tutorial-content');
            const btn = document.getElementById('tutorial-main-btn');

            title.innerText = "üéì UPUTE";
            content.innerHTML =
                `<div class="tutorial-step">‚ö° <span><strong style="color:#00ffcc">Misija:</strong> Napuni postaju energijom!</span></div>` +
                `<div class="tutorial-step">üß© <span><strong style="color:#00ffcc">Kako:</strong> Prevuci module u zonu.</span></div>` +
                `<div class="tutorial-step">üéØ <span><strong style="color:#00ffcc">Cilj:</strong> Zbroj mora biti <strong>TOƒåAN</strong>.</span></div>`;

            btn.innerText = "NASTAVI üöÄ";
            btn.onclick = closeInstructions;

            overlay.style.display = 'flex';
            isPaused = true;
        }

        function closeInstructions() {
            document.getElementById('tutorial-overlay').style.display = 'none';
            isPaused = false;
        }

        function showStartScreen() {
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tutorial-title');
            const content = document.getElementById('tutorial-content');
            const btn = document.getElementById('tutorial-main-btn');

            title.innerText = "ENERGETSKI NACRT";
            title.style.fontFamily = "'Courier New', monospace";
            title.style.borderBottom = "2px dashed #fff";
            title.style.display = "inline-block";
            title.style.paddingBottom = "5px";

            content.innerHTML =
                `<div class="tutorial-step" style="background: rgba(0,0,0,0.3); border:1px solid #00ffcc;">
                    ‚ö° <span><strong style="color:#00ffcc">ZADATAK:</strong> Stabiliziraj energetsku mre≈æu.</span>
                 </div>` +
                `<div class="tutorial-step" style="background: rgba(0,0,0,0.3); border:1px solid #00ffcc;">
                    üñ±Ô∏è <span><strong style="color:#00ffcc">ALAT:</strong> Prevuci i spusti (Drag & Drop).</span>
                 </div>`;

            btn.innerText = "IZVR≈†I PLAN üõ†Ô∏è";
            btn.style.background = "#fff";
            btn.style.color = "#002b36";
            btn.style.borderRadius = "5px";
            btn.style.border = "2px solid #00ffcc";
            btn.onclick = () => {
                closeInstructions();
                generateLevel();
            };

            overlay.style.display = 'flex';
        }

        function generateLevel() {
            isComplete = false;
            document.getElementById('levelText').innerText = `RAZINA: ${currentLevel} / 10`;
            document.getElementById('scoreText').innerText = `BODOVI: ${totalScore}`;
            targetEnergy = 5 + (currentLevel - 1) * 2; // Starts at 5, ends at 23
            if (currentLevel === 10) targetEnergy = 25;

            document.getElementById('energy-display').innerText = `0 / ${targetEnergy}`;
            document.getElementById('targetHint').innerHTML = `Prebaci module za napajanje. Cilj: <strong>toƒçno ${targetEnergy} panela</strong>.`;
            document.getElementById('status-msg').innerText = "Sustav ƒçeka napajanje...";
            document.getElementById('status-msg').style.color = "#00ffcc";
            document.getElementById('station-core').classList.remove('powered-up', 'overload');

            const storage = document.getElementById('modules-storage');
            const dock = document.getElementById('docking-zone');
            storage.innerHTML = '';
            dock.innerHTML = '';

            // Generate solution modules
            let remaining = targetEnergy;
            let modules = [];
            while (remaining > 0) {
                // Generate a random part (max 8)
                let val = Math.floor(Math.random() * Math.min(remaining, 8)) + 1; // 1 to 8
                modules.push(val);
                remaining -= val;
            }

            // Ensure we don't have too many modules for the solution itself (e.g. max 5 correct ones)
            while (modules.length > 5) {
                let a = modules.pop();
                let b = modules.pop();
                let sum = a + b;
                if (sum <= 8) {
                    modules.push(sum);
                } else {
                    modules.push(b);
                    modules.push(a);
                    break;
                }
            }

            // Fill the rest with decoys up to max 8 modules TOTAL
            const MAX_MODULES = 8;
            let attempts = 0;
            while (modules.length < MAX_MODULES && attempts < 20) {
                // Random decoy (1 to 8)
                let decoy = Math.floor(Math.random() * 8) + 1;
                modules.push(decoy);
                attempts++;
            }

            // Shuffle
            modules.sort(() => Math.random() - 0.5);

            modules.forEach((val, idx) => {
                const mod = document.createElement('div');
                mod.className = 'module';
                mod.id = `m${idx}`;
                mod.draggable = true;
                // Strict cap just in case something slipped through
                let finalVal = Math.min(val, 8);
                mod.dataset.panels = finalVal;
                mod.ondragstart = drag;

                const name = document.createElement('div');
                name.className = 'module-label';
                name.innerText = moduleNames[idx % moduleNames.length];

                const grid = document.createElement('div');
                grid.className = 'panels-grid';
                // Show up to 8 panels visually
                for (let i = 0; i < finalVal; i++) {
                    const p = document.createElement('div');
                    p.className = 'panel';
                    grid.appendChild(p);
                }

                mod.appendChild(name);
                mod.appendChild(grid);
                storage.appendChild(mod);
            });

            document.getElementById('success-overlay').style.display = 'none';
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function handleDrop(ev) {
            if (isPaused) return;
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(id);

            // Pronaƒëi najbli≈æi kontejner (ili docking-zone ili modules-storage)
            let targetZone = ev.target;
            while (targetZone && targetZone.id !== 'docking-zone' && targetZone.id !== 'modules-storage') {
                targetZone = targetZone.parentElement;
            }

            if (targetZone) {
                targetZone.appendChild(draggedElement);
                recalculateEnergy();
            }
        }

        function recalculateEnergy() {
            const dockingZone = document.getElementById('docking-zone');
            const modulesInDock = dockingZone.querySelectorAll('.module');
            const energyDisplay = document.getElementById('energy-display');
            const stationCore = document.getElementById('station-core');
            const statusMsg = document.getElementById('status-msg');

            let total = 0;
            modulesInDock.forEach(mod => {
                total += parseInt(mod.dataset.panels);
            });

            energyDisplay.innerText = `${total} / ${targetEnergy}`;

            // Resetiraj stilove
            stationCore.classList.remove('powered-up', 'overload');

            if (total === targetEnergy) {
                stationCore.classList.add('powered-up');
                statusMsg.innerText = "SISTEM AKTIVAN! Postaja radi savr≈°eno. üöÄ";
                statusMsg.style.color = "#00ff00";

                if (!isComplete) {
                    isComplete = true;
                    totalScore += 10;
                    if (typeof GameStorage !== 'undefined') {
                        GameStorage.addCredits(10);
                    }
                    document.getElementById('scoreText').innerText = `BODOVI: ${totalScore}`;

                    setTimeout(() => {
                        if (currentLevel < 10) {
                            document.getElementById('success-overlay').style.display = 'flex';
                        } else {
                            finishGame();
                        }
                    }, 800);
                }
            } else if (total > targetEnergy) {
                stationCore.classList.add('overload');
                statusMsg.innerText = "PREOPTEREƒÜENJE! Makni neki modul!";
                statusMsg.style.color = "#ff3300";
            } else if (total > 0) {
                statusMsg.innerText = "Nedovoljno energije za pokretanje...";
                statusMsg.style.color = "#00ccff";
            } else {
                statusMsg.innerText = "Sustav ƒçeka napajanje...";
                statusMsg.style.color = "#00ffcc";
            }
        }

        function nextLevel() {
            currentLevel++;
            generateLevel();
        }

        function finishGame() {
            document.getElementById('finalSummary').innerText = `Osvojeno: ${totalScore} / 100 bodova`;
            if (typeof GameStorage !== 'undefined') {
                GameStorage.saveProgress(GAME_ID, 11);
            }
            document.getElementById('win-overlay').style.display = 'flex';
        }

        // Init handled by start screen
        showStartScreen();
    </script>
</body>

</html>