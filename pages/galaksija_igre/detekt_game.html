<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8">
    <title>Kozmiƒçki Detektiv</title>
    <style>
        /* DETECTIVE THEME - Child Friendly Space Mystery */
        body {
            /* Softer, deep space blue instead of harsh black */
            background: radial-gradient(circle at center, #2e1a47 0%, #1a1a2e 100%);
            color: #ffffff;
            font-family: "Comic Sans MS", "Comic Sans", "Chalkboard SE", cursive;
            /* Dyslexia friendly standard */
            text-align: center;
            padding: 10px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        /* Scanline effect removed for cleaner look, added soft stars */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: transparent url('https://www.transparenttextures.com/patterns/stardust.png') repeat;
            opacity: 0.3;
            animation: rotateBackground 100s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes rotateBackground {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* RETURN BUTTON */
        .btn-back {
            position: absolute;
            top: 15px;
            left: 15px;
            text-decoration: none;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            /* Fully rounded */
            border: 3px solid #00d2ff;
            color: #00d2ff;
            transition: 0.2s;
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.2);
            z-index: 100;
            font-weight: bold;
        }

        .btn-back:hover {
            background: #00d2ff;
            color: #fff;
            transform: scale(1.05);
        }

        .game-title {
            color: #ffd700;
            font-size: clamp(2rem, 5vw, 3.5rem);
            text-shadow: 3px 3px 0px #d35400;
            margin: 0;
            z-index: 10;
            letter-spacing: 2px;
            padding-bottom: 10px;
        }

        .level-display {
            font-size: 1.8rem;
            color: #a29bfe;
            margin-bottom: 10px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 20px;
            border-radius: 20px;
        }

        .instruction-hint {
            font-size: 1.3rem;
            color: #e0d0ff;
            margin-bottom: 15px;
        }

        /* GAME GRID */
        .game-grid {
            display: grid;
            gap: 20px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 5px solid #a29bfe;
            border-radius: 30px;
            /* Softer edges */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .grid-item {
            width: 90px;
            height: 90px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            /* Squircle shape */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            border: 3px solid rgba(255, 255, 255, 0.3);
            user-select: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .grid-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) rotate(5deg);
            border-color: #ffd700;
        }

        .grid-item:active {
            transform: scale(0.9);
        }

        /* MODALS */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(46, 26, 71, 0.95);
            /* Deep purple overlay */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: #fdf6e3;
            /* Manila envelope color */
            color: #2c3e50;
            /* Dark ink color */
            border: 8px solid #d4c4a8;
            padding: 40px 30px;
            border-radius: 5px;
            /* Boxy dossier shape */
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.5);
            animation: bounceIn 0.5s;
            line-height: 1.5;
            transform: rotate(-1deg);
            /* Slight organic tilt */
            position: relative;
        }

        .modal-card::before {
            content: "TOP SECRET";
            position: absolute;
            top: 20px;
            left: -20px;
            background: #d00;
            color: #fff;
            padding: 5px 30px;
            transform: rotate(-25deg);
            font-weight: bold;
            font-family: 'Courier New', monospace;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.3);
            border: 2px dashed #fff;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        .modal-btn {
            padding: 15px 40px;
            font-size: 1.6rem;
            background: #00d2ff;
            border: none;
            border-radius: 50px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.2s;
            font-family: inherit;
            /* Keep Comic Sans */
            box-shadow: 0 5px 0 #0097b8;
            outline: none;
        }

        .modal-btn:hover {
            transform: translateY(-3px);
        }

        .modal-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0097b8;
        }

        .btn-start {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 6px 0 #27ae60;
            transition: transform 0.1s;
        }

        .btn-start:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #27ae60;
        }

        .tutorial-step {
            margin-bottom: 15px;
            font-size: 1.2rem;
            line-height: 1.5;
            color: #fff;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .modal-title {
            font-size: 2.5rem;
            margin: 0 0 15px 0;
            color: #ffd700;
            text-transform: uppercase;
        }

        .instructions {
            text-align: left;
            background: #f0f8ff;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            border: 2px dashed #00d2ff;
            font-size: 1.2rem;
            color: #333;
        }

        /* Shake Animation */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-10px);
            }

            40% {
                transform: translateX(10px);
            }

            60% {
                transform: translateX(-10px);
            }

            80% {
                transform: translateX(10px);
            }
        }

        .shake {
            animation: shake 0.4s ease-in-out;
        }
    </style>
</head>

<body>

    <a href="../galaxy.html" class="btn-back">‚¨Ö POVRATAK</a>

    <h1 class="game-title">KOZMIƒåKI DETEKTIV üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
    <div class="level-display" id="levelDisplay">RAZINA: 1 / 10</div>
    <div id="scoreText"
        style="font-size: 1.5rem; color: #ffd700; font-weight: bold; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 5px 20px; border-radius: 20px;">
        BODOVI: 0</div>
    <button onclick="showInstructions()"
        style="position: absolute; top: 15px; right: 15px; background: rgba(0, 210, 255, 0.1); border: 2px solid #00d2ff; color: #00d2ff; padding: 10px 20px; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; z-index: 100;"
        onmouseover="this.style.transform='scale(1.05)'; this.style.background='rgba(0, 210, 255, 0.2)'"
        onmouseout="this.style.transform='scale(1)'; this.style.background='rgba(0, 210, 255, 0.1)'">
        ‚ùì UPUTE
    </button>

    <p class="instruction-hint">Pronaƒëi uljeza! Jedan planet je drugaƒçiji.</p>

    <!-- GAME GRID -->
    <div class="game-grid" id="gameGrid">
        <!-- Items injected via JS -->
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div class="overlay" id="tutorial-overlay" style="display: flex;">
        <div class="modal-card">
            <h2 id="tutorial-title" class="modal-title" style="color: #6c5ce7;">UPUTE</h2>
            <div id="tutorial-content" style="text-align: left; margin: 20px 0;">
                <!-- Content injected by JS -->
            </div>
            <button class="btn-start" id="tutorial-main-btn" onclick="closeInstructions()">RAZUMIJEM! üöÄ</button>
        </div>
    </div>

    <!-- SUCCESS SCREEN -->
    <div class="overlay" id="successScreen">
        <div class="modal-card" style="border: 4px solid #2ecc71;">
            <h2 class="modal-title" style="color: #2ecc71;">ODLIƒåNO! ‚úÖ</h2>
            <p style="font-size: 1.5rem;">Na≈°ao/la si uljeza!</p>
            <button class="btn-start" onclick="nextLevel()" style="background: #2ecc71;">SLJEDEƒÜA RAZINA ‚û°</button>
        </div>
    </div>

    <!-- FAIL SCREEN -->
    <div class="overlay" id="failScreen">
        <div class="modal-card" style="border: 4px solid #ff6b6b;">
            <h2 class="modal-title" style="color: #ff6b6b;">UPS! ‚ùå</h2>
            <p style="font-size: 1.5rem;">To nije bio uljez. Poku≈°aj ponovo!</p>
            <button class="btn-start" onclick="restartLevel()"
                style="background: #ff6b6b; box-shadow: 0 6px 0 #e05656;">POKU≈†AJ PONOVO ‚Ü∫</button>
        </div>
    </div>

    <!-- WIN SCREEN -->
    <div class="overlay" id="winScreen">
        <div class="modal-card" style="border: 4px solid #ffd700;">
            <h2 class="modal-title" style="color: #ffd700;">BRAVO! üèÜ</h2>
            <p style="font-size: 1.5rem;">Pravi si Kozmiƒçki Detektiv! Svi sluƒçajevi su rije≈°eni.</p>
            <button class="btn-start" onclick="startGame()"
                style="background: #ffd700; color: #333; box-shadow: 0 6px 0 #d4b100;">IGRAJ PONOVO üéâ</button>
        </div>
    </div>

    <script src="../game_storage.js"></script>
    <script>
        // --- GAME DATA ---
        const EMOJIS = ['ü™ê', 'üöÄ', '‚≠ê', 'üåë', 'üëΩ', '‚òÑÔ∏è', 'üõ∞Ô∏è', 'üåå'];

        const GAME_ID = 'detekt_game';
        let totalScore = 0;
        let highScore = 0;

        // Initialize high score safely
        try {
            if (typeof GameStorage !== 'undefined') {
                highScore = GameStorage.getHighScore(GAME_ID);
            }
        } catch (e) {
            console.log("GameStorage not found");
        }

        let currentLevel = 1;
        let gridSize = 2; // Starts 2x2

        // --- AUDIO ---
        let audioCtx = null;
        function initAudio() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => console.log(e));
            } catch (e) { }
        }

        function playTone(freq, type = 'sine', duration = 0.1) {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.value = freq;
                osc.type = type;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { }
        }

        function playWin() { playTone(600, 'square', 0.1); setTimeout(() => playTone(800, 'square', 0.2), 100); }
        function playLoss() { playTone(200, 'sawtooth', 0.3); }

        // --- Tutorial Logic ---
        function showInstructions() {
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tutorial-title');
            const content = document.getElementById('tutorial-content');
            const btn = document.getElementById('tutorial-main-btn');

            title.innerText = "üéì UPUTE";
            content.innerHTML =
                `<div class="tutorial-step">üîé <span><strong style="color:#00d2ff">MISIJA:</strong> Pronaƒëi uljeza!</span></div>` +
                `<div class="tutorial-step">üëÄ <span><strong style="color:#00d2ff">KAKO:</strong> Klikni na predmet koji je drugaƒçiji (boja, oblik, smjer).</span></div>`;

            btn.innerText = "NASTAVI üöÄ";
            btn.onclick = closeInstructions;

            overlay.style.display = 'flex';
        }

        function closeInstructions() {
            document.getElementById('tutorial-overlay').style.display = 'none';
        }

        function showStartScreen() {
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tutorial-title');
            const content = document.getElementById('tutorial-content');
            const btn = document.getElementById('tutorial-main-btn');

            title.innerText = "DOSJE #10-24";
            title.style.color = "#2c3e50";
            title.style.fontFamily = "'Courier New', monospace";
            title.style.borderBottom = "2px solid #2c3e50";
            title.style.display = "inline-block";

            content.innerHTML =
                `<div class="tutorial-step" style="background: rgba(0,0,0,0.05); color:#333; border-left: 5px solid #d00;">
                    üîé <span><strong style="color:#d00">META:</strong> Identificiraj uljeza u sustavu.</span>
                 </div>` +
                `<div class="tutorial-step" style="background: rgba(0,0,0,0.05); color:#333; border-left: 5px solid #2ecc71;">
                    üëÜ <span><strong style="color:#2ecc71">TAKTIKA:</strong> Klikni na sumnjivi objekt.</span>
                 </div>`;

            btn.innerText = "OTVORI SLUƒåAJ üìÇ";
            btn.style.background = "#2c3e50";
            btn.style.boxShadow = "5px 5px 0px #95a5a6";
            btn.onclick = () => {
                closeInstructions();
                startGame();
            };

            overlay.style.display = 'flex';
        }

        // --- GAME LOGIC ---

        function startGame() {
            currentLevel = 1;
            document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
            initAudio();
            generateLevel();
        }

        function restartLevel() {
            document.getElementById('failScreen').style.display = 'none';
            generateLevel();
        }

        function nextLevel() {
            document.getElementById('successScreen').style.display = 'none';
            if (currentLevel > 10) {
                document.getElementById('winScreen').style.display = 'flex';
            } else {
                generateLevel();
            }
        }

        function generateLevel() {
            document.getElementById('levelDisplay').innerText = `RAZINA: ${currentLevel} / 10`;

            // DIFFICULTY SCALING
            let size = 2; // 2x2
            if (currentLevel > 3) size = 3; // 3x3 starts level 4
            if (currentLevel > 7) size = 4; // 4x4 starts level 8

            // Set Grid CSS
            const grid = document.getElementById('gameGrid');
            grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            grid.innerHTML = '';

            // Select Base Item
            const baseChar = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];

            // Determine Trait Difference
            // Lvl 1-3: Different Char
            // Lvl 4-6: Rotation
            // Lvl 7+: Hue or Scale

            let diffType = 'char';
            if (currentLevel > 3 && currentLevel <= 6) diffType = 'rotation';
            if (currentLevel > 6) diffType = 'hue';

            // Generate Items
            const totalItems = size * size;
            const intruderIndex = Math.floor(Math.random() * totalItems);

            for (let i = 0; i < totalItems; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerText = baseChar;

                if (i === intruderIndex) {
                    // APPLY DIFFERENCE
                    if (diffType === 'char') {
                        // Pick a different char
                        let newChar = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
                        while (newChar === baseChar) newChar = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
                        item.innerText = newChar;
                    } else if (diffType === 'hue') {
                        item.style.filter = 'hue-rotate(90deg)';
                    } else if (diffType === 'rotation') {
                        item.style.transform = 'rotate(180deg)';
                        // Reset hover for this specific implementation might be tricky in pure CSS if inline transform is used
                        // So we inject a specific class or leave it be, browser handles transform merge usually
                    }

                    // Click Event - WIN
                    item.onclick = () => handleWin();
                } else {
                    // Click Event - LOSE
                    item.onclick = (e) => handleLose(e.target);
                }

                grid.appendChild(item);
            }
        }

        function handleWin() {
            playWin();

            totalScore += 10;
            document.getElementById('scoreText').innerText = `BODOVI: ${totalScore}`;
            if (typeof GameStorage !== 'undefined') {
                GameStorage.addCredits(10);
                if (totalScore > highScore) {
                    highScore = totalScore;
                    GameStorage.saveHighScore(GAME_ID, highScore);
                }
            }

            currentLevel++;
            document.getElementById('successScreen').style.display = 'flex';
        }

        function handleLose(element) {
            playLoss();
            element.classList.add('shake');
            setTimeout(() => {
                element.classList.remove('shake');
                document.getElementById('failScreen').style.display = 'flex';
            }, 500);
        }

        // Init
        showStartScreen();
    </script>
</body>

</html>